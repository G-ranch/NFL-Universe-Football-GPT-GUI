-- ✅ Server-side logic
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local REMOTE_NAME = "DevTeleportHitboxControl"
local remote = ReplicatedStorage:FindFirstChild(REMOTE_NAME)
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = REMOTE_NAME
    remote.Parent = ReplicatedStorage
end

local HITBOX_MULTIPLIER = 5
local TELEPORT_DELAY = 0.5
local TELEPORT_OFFSET = CFrame.new(0, 0, -3)

local activeRequests = {}

local function getHRP(character)
    return character and (character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("LowerTorso"))
end

local function isEnemy(p1, p2)
    return p1 ~= p2 and ((p1.Team and p2.Team and p1.Team ~= p2.Team) or (not p1.Team or not p2.Team))
end

local function enlargeOthers(exclude)
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= exclude then
            local char = plr.Character
            local hrp = getHRP(char)
            if hrp and not hrp:FindFirstChild("DevHitboxOriginalSize") then
                local tag = Instance.new("Vector3Value")
                tag.Name = "DevHitboxOriginalSize"
                tag.Value = hrp.Size
                tag.Parent = hrp

                hrp.Size = hrp.Size * HITBOX_MULTIPLIER
                hrp.Transparency = 0.7
                hrp.Material = Enum.Material.ForceField
                hrp.CanCollide = false
            end
        end
    end
end

local function restoreHitboxes()
    for _, plr in pairs(Players:GetPlayers()) do
        local hrp = getHRP(plr.Character)
        if hrp then
            local tag = hrp:FindFirstChild("DevHitboxOriginalSize")
            if tag then
                hrp.Size = tag.Value
                hrp.Transparency = 0
                hrp.Material = Enum.Material.Plastic
                hrp.CanCollide = true
                tag:Destroy()
            end
        end
    end
end

local function teleportBehindEnemies(player)
    if not player or not player.Character then return end
    if activeRequests[player.UserId] then return end
    activeRequests[player.UserId] = true

    enlargeOthers(player)

    local enemies = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if isEnemy(plr, player) then
            table.insert(enemies, plr)
        end
    end

    for _, enemy in pairs(enemies) do
        local hrpEnemy = getHRP(enemy.Character)
        if hrpEnemy then
            for _ = 1, 5 do
                if not activeRequests[player.UserId] then break end
                local myHRP = getHRP(player.Character)
                if myHRP then
                    myHRP.CFrame = hrpEnemy.CFrame * TELEPORT_OFFSET
                end
                task.wait(TELEPORT_DELAY)
            end
        end
    end

    restoreHitboxes()
    activeRequests[player.UserId] = nil
end

remote.OnServerEvent:Connect(function(player, action)
    if action == "Start" then
        task.spawn(function() teleportBehindEnemies(player) end)
    elseif action == "Stop" then
        activeRequests[player.UserId] = nil
        restoreHitboxes()
    elseif action == "RestoreHitboxes" then
        restoreHitboxes()
    end
end)

-- ✅ Local GUI
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local remote = ReplicatedStorage:WaitForChild("DevTeleportHitboxControl")

local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "TeleportDevGui"
gui.ResetOnSpawn = false

local function createButton(name, yPos, color, text, onClick)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Size = UDim2.new(0, 120, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, yPos)
    btn.BackgroundColor3 = color
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 20
    btn.Parent = gui
    btn.MouseButton1Click:Connect(onClick)
end

createButton("StartBtn", 10, Color3.fromRGB(0,170,0), "Start", function()
    remote:FireServer("Start")
end)

createButton("StopBtn", 60, Color3.fromRGB(170,0,0), "Stop", function()
    remote:FireServer("Stop")
end)

createButton("RestoreBtn", 110, Color3.fromRGB(90,90,90), "Restore", function()
    remote:FireServer("RestoreHitboxes")
end)
